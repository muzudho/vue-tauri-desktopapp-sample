<template>

    <!-- æ©Ÿèƒ½ -->
    <button-20250822 ref="button1Ref"/>


    <!-- ã‚²ãƒ¼ãƒ ãƒã‚·ãƒ³ï¼šç”»é¢éƒ¨åˆ†é€éç”¨ãƒã‚¹ã‚¯ -->
    <svg width="0" height="0">
        <defs>
            <mask id="waratch2-mask-rect">
                <!-- å…¨ä½“ã®å¤§ãã•ã‚’ç™½ãå¡—ã‚‹ -->
                <rect x="0" y="0" :width="5 * screenSquareUnit" :height="7 * screenSquareUnit" fill="white"/>

                <!-- é€éã—ãŸã„ã¨ã“ã‚ã‚’é»’ãå¡—ã‚‹ -->
                <rect :x="screenMarginLeft" :y="screenSquareUnit" :width="3 * screenSquareUnit" :height="3 * screenSquareUnit" fill="black"/>
            </mask>
        </defs>
    </svg>


    <!-- ç”»é¢å†…ã‚’åˆ‡ã‚ŠæŠœã‹ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ -->
    <div
        class="waratch2-surface"
        :style="{
            ...props.hardLocationStyle,
            width: `${shassisWidth}px`,
            height: `${shassisHeight}px`,
        }"
    >
        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ã®è£åœ° -->
        <div
            :style="{
                position: 'absolute',
                boxSizing: 'border-box',
                left: `${screenMarginLeft - shassisBorderThickness}px`,   // ãƒœãƒ¼ãƒ€ãƒ¼å¹…ã‚’å¼•ã„ã¦ã„ã‚‹
                top: `${screenMarginTopRankNum * screenSquareUnit - shassisBorderThickness}px`,
                width: `${props.screenWidth}px`,
                height: `${props.screenHeight}px`,
                backgroundColor: 'olivedrab',
            }"
        ></div>
    </div>
        
    <!-- ã‚·ãƒ£ãƒ¼ã‚·ã€‚ç”»é¢éƒ¨åˆ†ã®çŸ©å½¢ã¯åˆ‡ã‚ŠæŠœã -->
    <div
        class="waratch2-shassis waratch2-trim-screen"
        :style="{
            ...props.hardLocationStyle,
            width: `${shassisWidth}px`,
            height: `${shassisHeight}px`,
        }"
    >

        <!-- ãƒãƒ¼ãƒ‰å -->
        <div
            class="waratch2-name-area"
            :style="{
                left: `${screenMarginLeft - shassisBorderThickness}px`,   // ãƒœãƒ¼ãƒ€ãƒ¼å¹…ã‚’å¼•ã„ã¦ã„ã‚‹
                top: `${screenMarginTopRankNum * screenSquareUnit + props.screenHeight - shassisBorderThickness}px`,
                width: `${props.screenWidth}px`,
                height: `${hardNameLineHeight}px`,
            }"
        ><span class="waratch2-name-1">Waratch2</span></div>
        

        <!-- TODO: ã‚²ãƒ¼ãƒ ç”»é¢ã‚’å…¥ã‚ŒãŸã„ -->
        <slot></slot>
    </div>


    <!-- ã‚¯ãƒªãƒƒã‚¯å¯èƒ½éƒ¨åˆ† -->
    <div
        class="waratch2-surface waratch2-clickable"
        :style="{
            ...props.hardLocationStyle,
            width: `${shassisWidth}px`,
            height: `${shassisHeight}px`
        }"
    >
        <!-- ãƒœã‚¿ãƒ³é…ç½® -->
        <div
            class="waratch2-buttons-area"
            :style="{
                top: `${screenMarginTopRankNum * screenSquareUnit + props.screenHeight + hardNameLineHeight + 8}px`, // 8 ã¯ç”»é¢ã¨ãƒœã‚¿ãƒ³ã®éš™é–“
                width: `${15 * controllerSquareUnit}px`,
                height: `${3 * controllerSquareUnit}px`,
            }"
        >
            <!-- ä¸Šã‚­ãƒ¼ -->
            <v-btn
                class="waratch2-button"
                :style="{
                    top: `${0 * controllerSquareUnit}px`,
                    left: `${1.5 * controllerSquareUnit}px`,
                    width: `${1 * controllerSquareUnit}px`,
                    height: `${1 * controllerSquareUnit}px`,
                }"
                @touchstart.prevent="button1Ref?.press($event, emit('onUpButtonPressed'), {repeat: true});"
                @touchend="button1Ref?.release(emit('onUpButtonReleased'));"
                @touchcancel="button1Ref?.release(emit('onUpButtonReleased'));"
                @touchleave="button1Ref?.release(emit('onUpButtonReleased'));"
                @mousedown.prevent="button1Ref?.handleMouseDown($event, emit('onUpButtonPressed'), {repeat: true})"
                @mouseup="button1Ref?.release(emit('onUpButtonReleased'));"
                @mouseleave="button1Ref?.release(emit('onUpButtonReleased'));"
                v-tooltip="'è‡ªæ©Ÿã‚’ä¸Šã¸ã€åƒã‚’é€†å‘ãã¸å‹•ã‹ã™ãœï¼'"
            >â†‘</v-btn>

            <!-- å·¦ã‚­ãƒ¼ -->
            <v-btn
                class="waratch2-button"
                :style="{
                    top: `${1 * controllerSquareUnit}px`,
                    left: `${0.5 * controllerSquareUnit}px`,
                    width: `${1 * controllerSquareUnit}px`,
                    height: `${1 * controllerSquareUnit}px`,
                }"
                @touchstart.prevent="button1Ref?.press($event, emit('onLeftButtonPressed'), {repeat: true});"
                @touchend="button1Ref?.release(emit('onLeftButtonReleased'));"
                @touchcancel="button1Ref?.release(emit('onLeftButtonReleased'));"
                @touchleave="button1Ref?.release(emit('onLeftButtonReleased'));"
                @mousedown.prevent="button1Ref?.handleMouseDown($event, emit('onLeftButtonPressed'), {repeat: true})"
                @mouseup="button1Ref?.release(emit('onLeftButtonReleased'));"
                @mouseleave="button1Ref?.release(emit('onLeftButtonReleased'));"
                v-tooltip="'è‡ªæ©Ÿã‚’å·¦ã¸ã€åƒã‚’é€†å‘ãã¸å‹•ã‹ã™ãœï¼'"
            >â†</v-btn>

            <!-- å³ã‚­ãƒ¼ -->
            <v-btn
                class="waratch2-button"
                :style="{
                    top: `${1 * controllerSquareUnit}px`,
                    left: `${2.5 * controllerSquareUnit}px`,
                    width: `${1 * controllerSquareUnit}px`,
                    height: `${1 * controllerSquareUnit}px`,
                }"
                @touchstart.prevent="button1Ref?.press($event, emit('onRightButtonPressed'), {repeat: true});"
                @touchend="button1Ref?.release(emit('onRightButtonReleased'));"
                @touchcancel="button1Ref?.release(emit('onRightButtonReleased'));"
                @touchleave="button1Ref?.release(emit('onRightButtonReleased'));"
                @mousedown.prevent="button1Ref?.handleMouseDown($event, emit('onRightButtonPressed'), {repeat: true})"
                @mouseup="button1Ref?.release(emit('onRightButtonReleased'));"
                @mouseleave="button1Ref?.release(emit('onRightButtonReleased'));"
                v-tooltip="'è‡ªæ©Ÿã‚’å³ã¸ã€åƒã‚’é€†å‘ãã¸å‹•ã‹ã™ãœï¼'"
            >â†’</v-btn>

            <!-- ä¸‹ã‚­ãƒ¼ -->
            <v-btn
                class="waratch2-button"
                :style="{
                    top: `${2 * controllerSquareUnit}px`,
                    left: `${1.5 * controllerSquareUnit}px`,
                    width: `${1 * controllerSquareUnit}px`,
                    height: `${1 * controllerSquareUnit}px`,
                }"
                @touchstart.prevent="button1Ref?.press($event, emit('onDownButtonPressed'), {repeat: true});"
                @touchend="button1Ref?.release(emit('onDownButtonReleased'));"
                @touchcancel="button1Ref?.release(emit('onDownButtonReleased'));"
                @touchleave="button1Ref?.release(emit('onDownButtonReleased'));"
                @mousedown.prevent="button1Ref?.handleMouseDown($event, emit('onDownButtonPressed'), {repeat: true})"
                @mouseup="button1Ref?.release(emit('onDownButtonReleased'));"
                @mouseleave="button1Ref?.release(emit('onDownButtonReleased'));"
                v-tooltip="'è‡ªæ©Ÿã‚’ä¸‹ã¸ã€åƒã‚’é€†å‘ãã¸å‹•ã‹ã™ãœï¼'"
            >â†“</v-btn>

            <!-- ã‚¹ãƒšãƒ¼ã‚¹ãƒ»ã‚­ãƒ¼ -->
            <v-btn
                class="waratch2-button"
                :style="{
                    top: `${1 * controllerSquareUnit}px`,
                    left: `${4.5 * controllerSquareUnit}px`,
                    width: `${2.5 * controllerSquareUnit}px`,
                    height: `${1 * controllerSquareUnit}px`,
                }"
                @touchstart.prevent="button1Ref?.press($event, emit('onSpaceButtonPressed'), {repeat: true});"
                @touchend="button1Ref?.release(emit('onSpaceButtonReleased'));"
                @touchcancel="button1Ref?.release(emit('onSpaceButtonReleased'));"
                @touchleave="button1Ref?.release(emit('onSpaceButtonReleased'));"
                @mousedown.prevent="button1Ref?.handleMouseDown($event, emit('onSpaceButtonPressed'), {repeat: true})"
                @mouseup="button1Ref?.release(emit('onSpaceButtonReleased'));"
                @mouseleave="button1Ref?.release(emit('onSpaceButtonReleased'));"
                v-tooltip="'è‡ªæ©Ÿã€å°å­—ã®ä½ç½®ã‚’æœ€åˆã«æœ‰ã£ãŸã¨ã“ã‚ã«æˆ»ã™ãœã€‚'"
            >ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ï¼‰</v-btn>

        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ãƒã‚·ãƒ³ã®æ ã€ãŠã‚ˆã³ç”»é¢ã«è½ã¡ã‚‹å½±ã€‚
        ãƒã‚¹ã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ£ãƒ‰ã‚¦ã‚’åˆ‡ã‚ŠæŠœã‹ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€ã‚²ãƒ¼ãƒ ãƒã‚·ãƒ³ã®å¤–ã«å‡ºã—ã¾ã™ã€‚
    -->
    <div
        class="waratch2-surface"
        :style="{
            ...props.hardLocationStyle,
            width: `${screenWidth}px`,
            height: `${screenHeight}px`,
        }"
    >
        <div
            class="waratch2-screen-frame"
            :style="{
                left: `${screenMarginLeft - shassisBorderThickness}px`,   // ãƒœãƒ¼ãƒ€ãƒ¼å¹…ã‚’å¼•ã
                top: `${screenMarginTopRankNum * screenSquareUnit - shassisBorderThickness}px`,
                width: `${screenWidth + 3}px`, // FIXME: ãªã‚“ã‚„åˆ†ã‹ã‚‰ã‚“+3
                height: `${screenHeight + 24 + 2}px`,   // FIXME: ãªã‚“ã‚„åˆ†ã‹ã‚‰ã‚“+24+2
            }"
        ></div>
    </div>

    <p>ğŸŒŸç”»é¢ã®å‘ã: {{ orientation }}</p>
</template>

<script setup lang="ts">

    // ##############
    // # ã‚¤ãƒ³ãƒãƒ¼ãƒˆ #
    // ##############

    import { onMounted, onUnmounted, ref } from 'vue';

    // ++++++++++++++++++++++++++++++
    // + ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€€ï¼ã€€äº’æ›æ€§å¯¾å¿œ +
    // ++++++++++++++++++++++++++++++

    import type { CompatibleStyleValue }  from '../compatibles/compatible-style-value';

    // ++++++++++++++++++++++++++++++++++
    // + ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€€ï¼ã€€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ +
    // ++++++++++++++++++++++++++++++++++
    //
    // Tauri ãªã‚‰æ˜ç¤ºçš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ Nuxt ãªã‚‰è‡ªå‹•ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã€‚
    //

    // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †
    import Button20250822 from '@/components/Button20250822.vue';


    // ####################################
    // # ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå—ã‘å–ã‚‹å¼•æ•° #
    // ####################################
    
    interface Props {
        hardLocationStyle: CompatibleStyleValue;
        screenWidth: number;
        screenHeight: number;
    }
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    const props = defineProps<Props>();


    // ################################################
    // # ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå—ã‘å–ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© #
    // ################################################

    interface Emits {
        // ã‚¤ãƒ™ãƒ³ãƒˆåã¨ã€å¤‰æ›´é€šçŸ¥ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã¨ã€ãã®ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ã€‚
        (event: 'onLeftButtonPressed'): void;
        (event: 'onLeftButtonReleased'): void;
        (event: 'onUpButtonPressed'): void;
        (event: 'onUpButtonReleased'): void;
        (event: 'onRightButtonPressed'): void;
        (event: 'onRightButtonReleased'): void;
        (event: 'onDownButtonPressed'): void;
        (event: 'onDownButtonReleased'): void;
        (event: 'onSpaceButtonPressed'): void;
        (event: 'onSpaceButtonReleased'): void;
        
    }
    const emit = defineEmits<Emits>();


    // ##########
    // # ã‚³ãƒ¢ãƒ³ #
    // ##########
    //
    // ã‚ˆãä½¿ã†è¨­å®šã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã€‚ç‰¹ã«ä¸å¤‰ã®ã‚‚ã®ã€‚
    //

    const shassisWidth = ref<number>(2 * 64 + props.screenWidth);
    const shassisHeight = ref<number>(4 * 64 + props.screenHeight);


    const screenSquareUnit: number = 64;
    const screenMarginLeft = ref<number>(1 * screenSquareUnit);

    const screenMarginTopRankNum: number = 1;
    const shassisBorderThickness: number = 4;
    const hardNameLineHeight: number = 24;
    const controllerSquareUnit: number = 40;

    // ################
    // # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ #
    // ################

    // ++++++++++++++++++++++++++++++++
    // + ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€€ï¼ã€€ãƒœã‚¿ãƒ³æ‹¡å¼µ +
    // ++++++++++++++++++++++++++++++++

    const button1Ref = ref<InstanceType<typeof Button20250822> | null>(null);


    // ###############
    // # é–‹å§‹ / çµ‚äº† #
    // ###############

    onMounted(()=>{
        // åˆå›ãƒã‚§ãƒƒã‚¯
        checkOrientation();
        // å‘ããŒå¤‰ã‚ã£ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.screen.orientation.addEventListener('change', checkOrientation);
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('resize', checkOrientation);
    });

    onUnmounted(()=>{
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç ´æ£„æ™‚ã«ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
        window.screen.orientation.removeEventListener('change', checkOrientation);
        window.removeEventListener('resize', checkOrientation);
    });

    // ################
    // # ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³ #
    // ################

    let orientation = ref<'Portrait' | 'Landscape'>('Landscape'); // Portrait:ç¸¦, Landscape:æ¨ª

    function checkOrientation() {
        // å˜ç´”ã«ç¸¦æ¨ªæ¯”ã§ãƒã‚§ãƒƒã‚¯ã€‚æ­£æ–¹å½¢ãªã‚‰ç¸¦ã¨ã™ã‚‹ã€‚
        orientation.value = window.innerWidth <= window.innerHeight ? 'Portrait' : 'Landscape';

        // // PCã§ã¯ã€ã‚ãã¾ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã§ã¯ãªãã€ç”»é¢ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã€‚
        // ã¡ã‚ƒã‚“ã¨æ¤œå‡ºã™ã‚‹ã‚±ãƒ¼ã‚¹ï¼š
        // const type = window.screen.orientation.type;
        // if (type.includes('portrait')) {
        //     orientation.value = 'ç¸¦ï¼ˆPortraitï¼‰';
        // } else if (type.includes('landscape')) {
        //     orientation.value = 'æ¨ªï¼ˆLandscapeï¼‰';
        // } else {
        //     orientation.value = 'ä¸æ˜';
        // }

        if (orientation.value == 'Portrait') {
            screenMarginLeft.value = 1 * screenSquareUnit;
        } else {
            screenMarginLeft.value = 3 * screenSquareUnit;
        }
    }

</script>

<style scoped>

    @import '@/styles/game-machine-waratch2.css';

</style>
